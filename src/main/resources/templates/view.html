<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세보기</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/view.css">
</head>
<body>
<div th:replace="header :: header"></div>

<main class="post-view">
    <section class="post-content">
        <form th:action="@{/view}" method="post">
            <input type="hidden" name="id" th:value="${board.id}" />

            <h2><input type="text" id="subject" name="subject" th:value="${board.subject}" readonly /></h2>
            <p class="post-meta">
                작성자: <span th:text="${board.writer}"></span> |
                작성일: <span th:text="${#temporals.format(board.createdDate, 'yyyy-MM-dd HH:mm')}"></span>
            </p>
            <div class="post-body">
                <textarea id="content" name="content" rows="6" readonly
                          th:text="${board.content}"></textarea>
            </div>

            <div th:if="${#authentication.name == board.writer}" class="post-actions">
                <button type="button" id="editBtn" onclick="enableEdit()">수정</button>
                <button type="submit" id="saveBtn" name="action" value="update" style="display:none;">저장</button>
                <button type="submit" name="action" value="delete" onclick="return confirm('정말 삭제하시겠습니까?');">삭제</button>
            </div>
            <a th:href="@{/list}" class="back-to-list">목록으로</a>
        </form>
    </section>

    <hr>

    <section class="comment-section">
        <h3>댓글</h3>
        <form th:action="@{/comment}" method="post" class="comment-form">
            <input type="hidden" name="board.id" th:value="${board.id}" />
            <input type="hidden" name="writer" th:value="${#authentication.name}" />
            <textarea name="content" rows="3" cols="50" placeholder="댓글을 입력하세요..."></textarea><br>
            <button type="submit">댓글 작성</button>
        </form>

        <div th:each="cmt : ${comments}" class="comment-box">
            <div class="comment-main">
                <div class="comment-header">
                <p><strong th:text="${cmt.writer}"></strong>: <span th:text="${cmt.content}"></span></p>
                <p class="comment-meta">
                    <small th:text="${#temporals.format(cmt.createdDate, 'yyyy-MM-dd HH:mm')}"></small>
                </p>

                <div th:if="${#authentication.name == cmt.writer}" class="comment-button">
                    <form th:action="@{/comment/action}" method="post">
                        <input type="hidden" name="id" th:value="${cmt.id}" />
                        <input type="hidden" name="board.id" th:value="${cmt.board.id}" />
                        <textarea name="content" th:text="${cmt.content}"></textarea><br>
                        <button type="submit" name="action" value="update">수정</button>
                        <button type="submit" name="action" value="delete" onclick="return confirm('정말 삭제하시겠습니까?');">삭제</button>
                    </form>
                </div>
            </div>

                </div>

            <div class="reply-form" style="margin-left: 30px;">
                <form th:action="@{/comment/reply}" method="post">
                    <input type="hidden" name="board.id" th:value="${cmt.board.id}" />
                    <input type="hidden" name="parentId" th:value="${cmt.id}" />
                    <textarea name="content" rows="2" cols="40" placeholder="대댓글 작성..."></textarea><br>
                    <button type="submit">답글 달기</button>
                </form>
            </div>

            <div th:each="reply : ${cmt.replies}" class="reply-box" style="margin-left: 40px;">
                <p><strong th:text="${reply.writer}"></strong>: <span th:text="${reply.content}"></span></p>
                <p><small th:text="${#temporals.format(reply.createdDate, 'yyyy-MM-dd HH:mm')}"></small></p>

                <div th:if="${#authentication.name == reply.writer}" class="reply-actions">
                    <form th:action="@{/comment/action}" method="post">
                        <input type="hidden" name="id" th:value="${reply.id}" />
                        <input type="hidden" name="board.id" th:value="${reply.board.id}" />
                        <textarea name="content" th:text="${reply.content}"></textarea><br>
                        <button type="submit" name="action" value="update">수정</button>
                        <button type="submit" name="action" value="delete" onclick="return confirm('정말 삭제하시겠습니까?');">삭제</button>
                    </form>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
    function enableEdit() {
        document.getElementById('subject').readOnly = false;
        document.getElementById('content').readOnly = false;
        document.getElementById('editBtn').style.display = 'none';
        document.getElementById('saveBtn').style.display = 'inline';
    }
</script>
</body>
</html>
